<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0065)http://craftyjs.github.com/tutorial/bananabomber/input-and-events -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1250">
	<title>Crafty - Keyboard input and binding to events</title>
	<link type="text/css" rel="stylesheet" href="./Crafty - Keyboard input and binding to events_files/global.css">
	<link href="./Crafty - Keyboard input and binding to events_files/css" rel="stylesheet" type="text/css">
	<link rel="shortcut icon" href="http://craftyjs.github.com/favicon.ico">
	<script type="text/javascript" async="" src="./Crafty - Keyboard input and binding to events_files/ga.js"></script><script src="./Crafty - Keyboard input and binding to events_files/jquery.min.js" type="text/javascript"></script>
	<link href="./Crafty - Keyboard input and binding to events_files/pygments_style.css" type="text/css" rel="stylesheet">
	<script type="text/javascript">

		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-23935213-2']);
		_gaq.push(['_trackPageview']);

		(function () {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();

</script>
<meta name="chromesniffer" id="chromesniffer_meta" content="{&quot;Google Analytics&quot;:-1,&quot;GoogleFontApi&quot;:-1,&quot;jQuery&quot;:&quot;1.5.2&quot;}"><script type="text/javascript" src="chrome-extension://homgcnaoacgigpkkljjjekpignblkeae/detector.js"></script></head>
<body>
	<div id="header">
		<div id="inner">
			<a href="http://craftyjs.com/">
				<img id="logo" src="./Crafty - Keyboard input and binding to events_files/logo.png" alt="Crafty - JavaScript HTML5 Game Engine"></a>
			<ul>
				<li><a href="http://craftyjs.github.com/tutorial/">Getting Started</a></li>
				<li><a href="http://craftyjs.com/api/">Documentation</a></li>
				<li><a href="https://groups.google.com/forum/#!forum/craftyjs">Forum</a></li>
				<li><a href="http://craftycomponents.com/">Modules</a></li>
				<li><a href="http://craftyjs.tumblr.com/">Blog</a></li>
				<li class="emph"><a href="http://craftyjs.com/download.php">Download</a></li>
			</ul>
		</div>
	</div>
	<div id="main">
		<div id="main-left">
		</div>
		<div id="main-right">
		</div>
		<div id="content">
			
			<div id="doc-nav">
	<ul id="doc-level-one">
		<li>
			Getting started
			<ul>
				<li><a href="http://craftyjs.github.com/tutorial/getting-started/how-crafty-works">How Crafty works</a></li>
				<li><a href="http://craftyjs.github.com/tutorial/getting-started/download-and-setup">Download and setup</a></li>
			</ul>
		</li>
		<li>
			Entities and components
			<ul>
				<li><a href="http://craftyjs.github.com/tutorial/entities-components/providing-structure">Providing structure</a></li>
				<li><a href="http://craftyjs.github.com/tutorial/entities-components/a-game">Example game</a></li>
			</ul>
		</li>
		<li>
			Events
			<ul>
				<li><a href="http://craftyjs.github.com/tutorial/event-binding/fire-and-forget">communication</a></li>
				<li><a href="http://craftyjs.github.com/tutorial/event-binding/a-game">Example game</a></li>
			</ul>
		</li>
		<li>
			Top-down game: Bananabomber
			<ul>
				<li><a href="http://craftyjs.github.com/tutorial/bananabomber/create-a-game">Create a game</a></li>
				<li><a href="http://craftyjs.github.com/tutorial/bananabomber/graphics">Sprites and animations</a></li>
				<li><a href="./Crafty - Keyboard input and binding to events_files/Crafty - Keyboard input and binding to events.htm">Movement, controls, events</a></li>
			</ul>
		</li>
		<li>
			Administrative
			<ul>
				<li><a href="http://craftyjs.github.com/tutorial/administrative/structure">Structure</a></li>
			</ul>
		</li>
		<li>
			Resources
			<ul>
				<li><a href="http://craftyjs.github.com/tutorial/resources">Resources list</a></li>
			</ul>
		</li>

		<li>
			Flexpi integration
			<ul>
				<li><a href="http://craftyjs.github.com/tutorial/integrations/flexpi/introduction">Introduction</a></li>
				<li><a href="http://craftyjs.github.com/tutorial/integrations/flexpi/custom-data-logging">Custom data logging</a></li>
				<li><a href="http://craftyjs.github.com/tutorial/integrations/flexpi/login-user-with-social">Login user with social</a></li>
				<li><a href="http://craftyjs.github.com/tutorial/integrations/flexpi/sell-premium-items-in-game">Sell premium items in game</a></li>
				<li><a href="http://craftyjs.github.com/tutorial/integrations/flexpi/add-badge-for-user">Add badge for user</a></li>
			</ul>
		</li>
	</ul>
</div>
<div id="doc-content">

<h2> Keyboard input and binding to events </h2>

	<p>Events are how components in Crafty talk to each other. In this article we will bind to events from Craftys Keyboard component to make it possible for a player to control the main character.</p>

<p>The following code will create the player entity. The Ape component provides collision handling and some nice walking animations. We shall create this component in a moment. The LeftControls component will handle keyboard input and BombDropper will give out hero the ability to throw bombs. You may recall from the last article that we defined a sprite component called player:</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">//create our player entity with some premade components</span>
<span class="kd">var</span> <span class="nx">player1</span> <span class="o">=</span> <span class="nx">Crafty</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="s2">"2D, DOM, Ape, player, LeftControls, BombDropper"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">({</span> <span class="nx">x</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">304</span><span class="p">,</span> <span class="nx">z</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">leftControls</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">Ape</span><span class="p">();</span>
</code></pre>
</div>
<p>The entity is positioned in the bottom left corner and the constructors for two of the entities components are called.</p>

<h2 id="creating_a_component">Creating a component</h2>

<p>Lets build the LeftControls component right away to get our player moving:</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">Crafty</span><span class="p">.</span><span class="nx">c</span><span class="p">(</span><span class="s2">"LeftControls"</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">requires</span><span class="p">(</span><span class="s1">'Multiway'</span><span class="p">);</span>
    <span class="p">},</span>
    
    <span class="nx">leftControls</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">speed</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">multiway</span><span class="p">(</span><span class="nx">speed</span><span class="p">,</span> <span class="p">{</span><span class="nx">W</span><span class="o">:</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="nx">S</span><span class="o">:</span> <span class="mi">90</span><span class="p">,</span> <span class="nx">D</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">A</span><span class="o">:</span> <span class="mi">180</span><span class="p">})</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
    
<span class="p">});</span>
</code></pre>
</div>
<p>As you can see it is pretty easy to define a component. The LeftControls component has two functions. These functions are added to new entities that are created with this component, like the player1 entity above. This means that the this keyword will point to the specific entity the function is called on. init is a magic function that is called by crafty right after a new entity has been created.</p>

<p>When you want to be able to change the behavior of the component in different entities you need some way to pass a parameter to the initialization code. For this purpose it is convention to create a constructor that must be called when a entity is created. In this case the variability point is the speed of the entity.</p>

<p>We take advantage of the Multiway component that is part of Crafty (0.4.3+). It is initialized by calling its constructor with two arguments: an integer specifying speed and an object with mappings from keyboard input to a direction. In this case we map W-A-S-D to up-left-down-right. The multiway component binds a function to the enterframe event and moves the entity as needed. It also triggers an event when direction changes. we will use this in the Ape component to animate the player when walking.</p>

<p>Notice how we return the entity object in the leftControls constructor. This convention enables us to chain component constructor calls as we did in the player1 entity: .leftControls(1).Ape();. This convention is followed throughout the crafty code base and i suggest you do as well.</p>

<p>Now for the Ape component that adds animations and collision detection:</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">Crafty</span><span class="p">.</span><span class="nx">c</span><span class="p">(</span><span class="s1">'Ape'</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">Ape</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">//setup animations</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">requires</span><span class="p">(</span><span class="s2">"SpriteAnimation, Collision, Grid"</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">animate</span><span class="p">(</span><span class="s2">"walk_left"</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">animate</span><span class="p">(</span><span class="s2">"walk_right"</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">animate</span><span class="p">(</span><span class="s2">"walk_up"</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">animate</span><span class="p">(</span><span class="s2">"walk_down"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</code></pre>
</div>
<p>We setup four animations in the same way the flower animation was set up in a previous article by specifying the position of first frame of the animation and the amount of frames.</p>

<h2 id="binding_to_events">Binding to events</h2>

<p>Remember that the MultiWay component triggers a NewDirection event when the entity changes direction. We use this to change the animation accordingly. You bind to an event by providing a function that should be called when the event is triggered. If the event ha any data associated to it, you can access it by adding a parameter to the function. In this case the direction parameter in our callback will be an object of the form {x, y} specifying current movement along x- and y-axes:</p>
<div class="highlight"><pre><code class="javascript"><span class="c1">//change direction when a direction change event is received</span>
<span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"NewDirection"</span><span class="p">,</span>
    <span class="kd">function</span> <span class="p">(</span><span class="nx">direction</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">direction</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isPlaying</span><span class="p">(</span><span class="s2">"walk_left"</span><span class="p">))</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">().</span><span class="nx">animate</span><span class="p">(</span><span class="s2">"walk_left"</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">direction</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isPlaying</span><span class="p">(</span><span class="s2">"walk_right"</span><span class="p">))</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">().</span><span class="nx">animate</span><span class="p">(</span><span class="s2">"walk_right"</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">direction</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isPlaying</span><span class="p">(</span><span class="s2">"walk_up"</span><span class="p">))</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">().</span><span class="nx">animate</span><span class="p">(</span><span class="s2">"walk_up"</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">direction</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isPlaying</span><span class="p">(</span><span class="s2">"walk_down"</span><span class="p">))</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">().</span><span class="nx">animate</span><span class="p">(</span><span class="s2">"walk_down"</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">direction</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">direction</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
        <span class="p">}</span>
<span class="p">})</span>
</code></pre>
</div>
<h2 id="collision_detection">Collision Detection</h2>

<p>The next part of the Ape component deals with collision detection to prevent the user from walking through solid tiles. You might recall that when generating the world we marked bushes and flowers with a fictive component called solid.</p>

<p>Crafty’s collision detection works on the level of components. You specify the name of a component, and whenever the entity collides with an entity with that component your callback is called.</p>
<div class="highlight"><pre><code class="javascript"><span class="p">.</span><span class="nx">onHit</span><span class="p">(</span><span class="s2">"solid"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">//Move unit out of solid tile</span>
<span class="p">})</span>
</code></pre>
</div>
<p>The collision check is run on each enterframe. When collision is detected, the entity has already walked into a solid tile, so we have to move it out again to do this we have to know it’s direction and speed. We can get this information from private variables provided by the LeftControls component, but that is a bit clumsy. Also the above approach has the problem that the collision detection is done after the unit has moved in bot x- and -y direction. If a collision is detected we have no choice but to move the unit back to where it came from, even if movement along one of the axes would have been valid.</p>

<p>You probably guessed it - there is a better way to do it :-)</p>

<p>The MultiWay component triggers an event every time the unit has moved either on the x- or y-axis providing the coordinates the unit moved from:</p>
<div class="highlight"><pre><code class="javascript"><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'Moved'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hit</span><span class="p">(</span><span class="s1">'solid'</span><span class="p">)){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">attr</span><span class="p">({</span><span class="nx">x</span><span class="o">:</span> <span class="nx">from</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="nx">from</span><span class="p">.</span><span class="nx">y</span><span class="p">});</span>
    <span class="p">}</span>
<span class="p">})</span>
</code></pre>
</div>
<p>In the next article we will build a bombDropper component. this last bit of the Ape component is a teaser for you:</p>
<div class="highlight"><pre><code class="javascript">            <span class="p">.</span><span class="nx">onHit</span><span class="p">(</span><span class="s2">"fire"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
  			<span class="c1">// Subtract life and play scream sound :-)</span>
            <span class="p">});</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>
<p>Let’s put two players on the map by extending the main scene a bit:</p>
<div class="highlight"><pre><code class="javascript"><span class="nx">Crafty</span><span class="p">.</span><span class="nx">scene</span><span class="p">(</span><span class="s2">"main"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">generateWorld</span><span class="p">();</span>
    
    <span class="c1">//create our player entity with some premade components</span>
    <span class="kd">var</span> <span class="nx">player1</span> <span class="o">=</span> <span class="nx">Crafty</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="s2">"2D, DOM, Ape, player, LeftControls, BombDropper"</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">({</span> <span class="nx">x</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">304</span><span class="p">,</span> <span class="nx">z</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
            <span class="p">.</span><span class="nx">leftControls</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">Ape</span><span class="p">();</span>
    
    <span class="c1">//create our player entity with some premade components</span>
    <span class="kd">var</span> <span class="nx">player2</span> <span class="o">=</span> <span class="nx">Crafty</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="s2">"2D, DOM, Ape, player, RightControls, BombDropper"</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">({</span> <span class="nx">x</span><span class="o">:</span> <span class="mi">368</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span> <span class="nx">z</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
            <span class="p">.</span><span class="nx">rightControls</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">bombDropper</span><span class="p">(</span><span class="nx">Crafty</span><span class="p">.</span><span class="nx">keys</span><span class="p">.</span><span class="nx">ENTER</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">Ape</span><span class="p">();</span>
<span class="p">});</span>
</code></pre>
</div>
<p>Building a RightControls component is left as an exercise…</p>
</div>

			
		</div>
	</div>
	<div class="clearer"> </div> <div id="footer"> <div id="contact"> <a href="http://twitter.com/craftyjs">
	<img src="./Crafty - Keyboard input and binding to events_files/twitter.png"> @craftyjs</a> <a href="http://webchat.freenode.net/">
	<img src="./Crafty - Keyboard input and binding to events_files/comment.png"> #crafty@freenode.net</a> <a href="https://groups.google.com/forum/#!forum/craftyjs">
	<img src="./Crafty - Keyboard input and binding to events_files/google.png"> google groups</a> <a href="mailto:louis@craftyjs.com">
	<img src="./Crafty - Keyboard input and binding to events_files/email.png"> louis@craftyjs.com</a> <a href="https://github.com/craftyjs/Crafty">
	<img src="./Crafty - Keyboard input and binding to events_files/github.png"> github</a> </div> <ul> <li><a href="http://craftyjs.com/api/">Documentation</a></li>
	<li><a href="http://craftycomponents.com/">Modules</a></li> <li><a href="https://groups.google.com/forum/#!forum/craftyjs">Forum</a></li>
	<li><a href="http://craftyjs.github.com/tutorial/">Tutorial</a></li> <li><a href="http://craftyjs.com/demos.php">Demos</a></li>
	<li><a href="http://craftyjs.tumblr.com/">Blog</a></li> <li><a href="http://craftyjs.com/download.php">Download</a></li>
	</ul> <p> © Crafty 2010. Crafty is distributed under the <a href="http://en.wikipedia.org/wiki/MIT_License">
	MIT</a> or <a href="http://en.wikipedia.org/wiki/GNU_General_Public_License">GPL</a>
	license.</p> </div>


</body></html>